<!DOCTYPE html>
<html id="mainHtml" lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>فست فود سیب - منوی آنلاین</title>
    <style>
        :root { 
            --primary: #d3ad7f; --bg: #13131a; --card: #1e1e24; --text: #ffffff; --green: #27ae60; --blue: #2980b9; --input-bg: #2a2a35; 
            --header-img: url('https://images.unsplash.com/photo-1513104890138-7c749659a591?auto=format&fit=crop&w=1000&q=80');
            --bg-img: url('https://images.unsplash.com/photo-1550547660-d9450f859349?auto=format&fit=crop&w=1000&q=80');
        }
        * { margin:0; padding:0; box-sizing:border-box; font-family:'Tahoma', sans-serif; -webkit-tap-highlight-color: transparent; }
        body { background: linear-gradient(rgba(19, 19, 26, 0.85), rgba(19, 19, 26, 0.85)), var(--bg-img); background-size: cover; background-attachment: fixed; background-position: center; color:var(--text); padding-bottom:150px; user-select: none; }
        header { background: linear-gradient(rgba(0,0,0,0.4), rgba(0,0,0,0.4)), var(--header-img); background-size: cover; background-position: center; padding: 50px 20px; text-align: center; border-bottom: 3px solid var(--primary); position: sticky; top: 0; z-index: 100; box-shadow: 0 4px 15px rgba(0,0,0,0.6); }
        .lang-switch { position: absolute; top: 10px; right: 10px; display: flex; gap: 5px; z-index: 1001; }
        .lang-btn { background: rgba(0,0,0,0.7); border: 1px solid var(--primary); color: #fff; padding: 5px 10px; border-radius: 5px; font-size: 0.75rem; cursor: pointer; }
        .lang-btn.active { background: var(--primary); color: #000; font-weight: bold; }
        header h1 { font-size: 1.8rem; color: #fff; text-shadow: 2px 2px 4px rgba(0,0,0,0.8); margin-bottom: 5px; }
        .status-badge { font-size: 0.85rem; padding: 5px 12px; border-radius: 12px; display: inline-block; margin-top: 5px; font-weight: bold; }
        .open { background: #27ae60; color: #fff; } .closed { background: #c0392b; color: #fff; }
        .cat-scroll { display: flex; gap: 10px; padding: 15px; overflow-x: auto; background: rgba(11, 11, 15, 0.8); backdrop-filter: blur(5px); }
        .cat-btn { background: var(--card); color: #fff; padding: 8px 16px; border-radius: 20px; border: 1px solid #333; white-space: nowrap; cursor: pointer; }
        .cat-btn.active { background: var(--primary); border-color: var(--primary); color: #000; font-weight: bold; }
        .menu-list { padding: 15px; max-width: 600px; margin: 0 auto; min-height: 300px; }
        .item { background: rgba(30, 30, 36, 0.9); border-radius: 12px; padding: 10px; margin-bottom: 12px; display: flex; gap: 12px; border: 1px solid #2a2a35; align-items: center; animation: fadeIn 0.5s; position: relative; }
        .item img { width: 80px; height: 80px; border-radius: 8px; object-fit: cover; border: 1px solid var(--primary); background: #000; }
        .price { color: var(--primary); font-weight: bold; font-size: 1.1rem; }
        .add-btn { background: #333; color: #fff; padding: 6px 15px; border-radius: 8px; font-size: 0.9rem; cursor: pointer; }
        .qty-box { display: flex; align-items: center; background: #000; border-radius: 6px; border: 1px solid var(--primary); }
        .q-btn { width: 35px; height: 30px; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; cursor: pointer; color: var(--primary); }
        .q-num { width: 25px; text-align: center; font-weight: bold; font-size: 1rem; }
        .cart-bar { position: fixed; bottom: 0; left: 0; right: 0; background: #000; padding: 15px; z-index: 1000; display: none; border-top: 1px solid #333; }
        .final-btn { background: var(--green); color: #fff; padding: 12px; border-radius: 12px; font-weight: bold; cursor: pointer; font-size: 1rem; text-align: center; width: 100%; }
        @keyframes fadeIn { from { opacity:0; transform:translateY(10px); } to { opacity:1; transform:translateY(0); } }
    </style>
</head>
<body>
    <div class="lang-switch">
        <button class="lang-btn active" id="btn-fa" onclick="setLang('fa')">FA</button>
        <button class="lang-btn" id="btn-en" onclick="setLang('en')">EN</button>
    </div>
    <header><h1 id="shopName">...</h1><div id="shopStatus" class="status-badge">...</div></header>
    <div class="cat-scroll" id="cats"></div>
    <div class="menu-list" id="list"></div>
    <div class="cart-bar" id="cartBar"><div class="final-btn" onclick="processOrder()">پرداخت و ثبت نهایی</div></div>

    <script>
        const sheetId = "1XoE-tWd9sor7HgqQe67z3JQCZyvt6G-IcSz9u1miRiw";
        let curLang = 'fa', currentCat = 'all', products = [], cart = {}, dictionary = {}, config = { isOpen:true, paymentLink:'', phone:'', deliveryPrice:0 };

        async function startApp() {
            try {
                const fetchRaw = async (sheet) => {
                    const r = await fetch(`https://docs.google.com/spreadsheets/d/${sheetId}/gviz/tq?tqx=out:csv&sheet=${sheet}&cb=${Date.now()}`);
                    const text = await r.text();
                    // اگر گوگل صفحه لاگین برگرداند
                    if (text.includes('<!DOCTYPE')) alert("لطفاً در گوگل شیت دکمه Share را زده و Anyone with link را انتخاب کنید.");
                    return text;
                };
                
                const [mText, sText, tText] = await Promise.all([fetchRaw('Menu'), fetchRaw('Settings'), fetchRaw('Translations')]);
                
                // --- استخراج هوشمند لینک آیدی‌پی از کل متن شیت تنظیمات ---
                // این بخش کوتیشن‌ها و ویرگول‌های قاطی شده را نادیده می‌گیرد
                const idpayPattern = /https:\/\/idpay\.ir\/[a-zA-Z0-9_\-]+/;
                const foundLink = sText.match(idpayPattern);
                if (foundLink) config.paymentLink = foundLink[0];

                // استخراج سایر تنظیمات
                sText.split(/\r?\n/).forEach(row => {
                    const r = row.split(',').map(c => c.replace(/"/g,'').trim());
                    if (r[0]?.toLowerCase().includes('phone')) config.phone = r[1] || r[0].split(',')[1];
                    if (r[0]?.toLowerCase().includes('price')) config.deliveryPrice = parseInt(r[1]) || 0;
                    if (r[0]?.toLowerCase().includes('open')) config.isOpen = r[1]?.toUpperCase() !== 'FALSE';
                });

                // محصولات
                mText.split(/\r?\n/).slice(1).forEach((row, i) => {
                    const r = row.split(',').map(c => c.replace(/"/g,'').trim());
                    if(r.length < 7) return;
                    products.push({ id: i, cat: { fa: r[0], en: r[1] }, title: { fa: r[3], en: r[4] }, p: parseInt(r[6].replace(/,/g,'')), img: r[7], active: r[8]?.toUpperCase() !== 'FALSE' });
                });

                setLang('fa');
            } catch (e) { console.error(e); }
        }

        const getT = (k) => (dictionary[k] && dictionary[k][curLang]) ? dictionary[k][curLang] : k;
        function setLang(l) {
            curLang = l; document.getElementById('shopName').innerText = "فست فود سیب";
            const s = document.getElementById('shopStatus');
            s.innerText = config.isOpen ? "باز است" : "بسته است";
            s.className = "status-badge " + (config.isOpen ? "open" : "closed");
            renderMenu(currentCat);
        }

        function renderMenu(cat) {
            currentCat = cat; const list = document.getElementById('list'), catsDiv = document.getElementById('cats');
            const catSet = ['all', ...new Set(products.map(p => p.cat[curLang]))];
            catsDiv.innerHTML = catSet.map(c => `<div class="cat-btn ${ (cat === c) ? 'active' : ''}" onclick="renderMenu('${c}')">${c === 'all' ? 'همه' : c}</div>`).join('');
            list.innerHTML = '';
            products.filter(p => cat === 'all' || p.cat[curLang] === cat).forEach(p => {
                const count = cart[p.id] || 0;
                const btn = !p.active ? `<span style="color:red;">تمام شد</span>` : (count === 0 ? `<div class="add-btn" onclick="upd(${p.id},1)">افزودن</div>` : `<div class="qty-box"><div class="q-btn" onclick="upd(${p.id},1)">+</div><span class="q-num">${count}</span><div class="q-btn" onclick="upd(${p.id},-1)">-</div></div>`);
                list.innerHTML += `<div class="item"><img src="${p.img}"><div style="flex:1"><h3>${p.title[curLang]}</h3><div style="display:flex;justify-content:space-between;align-items:center;"><span style="color:#d3ad7f;font-weight:bold;">${p.p.toLocaleString()}</span>${btn}</div></div></div>`;
            });
            document.getElementById('cartBar').style.display = Object.keys(cart).length > 0 ? 'block' : 'none';
        }

        window.upd = (id, n) => { cart[id] = (cart[id] || 0) + n; if(cart[id]<=0) delete cart[id]; renderMenu(currentCat); };

        window.processOrder = () => {
            let total = 0; for(let id in cart) total += products[id].p * cart[id];
            if(config.paymentLink && config.paymentLink.includes('idpay.ir')) {
                // چسباندن مبلغ و باز کردن در تب جدید
                const finalUrl = config.paymentLink + (config.paymentLink.includes('?') ? '&' : '?') + "amount=" + total + "0";
                window.open(finalUrl, '_blank');
            } else {
                alert("خطا: لینک پرداخت در گوگل شیت یافت نشد. لطفاً سطر 5 در شیت Settings را چک کنید.");
            }
        };

        startApp();
    </script>
</body>
</html>
