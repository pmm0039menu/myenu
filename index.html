<!DOCTYPE html>
<html id="mainHtml" lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>منوی آنلاین</title>
    <style>
        :root { 
            --primary: #d3ad7f; --bg: #13131a; --card: #1e1e24; --text: #ffffff; --green: #27ae60; --blue: #2980b9; --input-bg: #2a2a35; 
            --header-img: url('https://images.unsplash.com/photo-1513104890138-7c749659a591?auto=format&fit=crop&w=1000&q=80');
            --bg-img: url('https://images.unsplash.com/photo-1550547660-d9450f859349?auto=format&fit=crop&w=1000&q=80');
        }
        * { margin:0; padding:0; box-sizing:border-box; font-family:'Tahoma', sans-serif; }
        body { background: linear-gradient(rgba(19, 19, 26, 0.85), rgba(19, 19, 26, 0.85)), var(--bg-img); background-size: cover; background-attachment: fixed; color:var(--text); padding-bottom:150px; }
        header { background: linear-gradient(rgba(0,0,0,0.4), rgba(0,0,0,0.4)), var(--header-img); background-size: cover; padding: 50px 20px; text-align: center; border-bottom: 3px solid var(--primary); position: sticky; top: 0; z-index: 100; }
        .lang-switch { position: absolute; top: 10px; right: 10px; display: flex; gap: 5px; z-index: 1001; }
        .lang-btn { background: rgba(0,0,0,0.7); border: 1px solid var(--primary); color: #fff; padding: 5px 10px; border-radius: 5px; font-size: 0.75rem; cursor: pointer; }
        .lang-btn.active { background: var(--primary); color: #000; font-weight: bold; }
        header h1 { font-size: 1.8rem; text-shadow: 2px 2px 4px rgba(0,0,0,0.8); }
        .status-badge { font-size: 0.85rem; padding: 5px 12px; border-radius: 12px; display: inline-block; margin-top: 5px; }
        .open { background: #27ae60; } .closed { background: #c0392b; }
        .cat-scroll { display: flex; gap: 10px; padding: 15px; overflow-x: auto; background: rgba(11, 11, 15, 0.8); }
        .cat-btn { background: var(--card); color: #fff; padding: 8px 16px; border-radius: 20px; border: 1px solid #333; white-space: nowrap; }
        .cat-btn.active { background: var(--primary); color: #000; font-weight: bold; }
        .menu-list { padding: 15px; max-width: 600px; margin: 0 auto; }
        .item { background: rgba(30, 30, 36, 0.9); border-radius: 12px; padding: 10px; margin-bottom: 12px; display: flex; gap: 12px; align-items: center; }
        .item img { width: 80px; height: 80px; border-radius: 8px; object-fit: cover; }
        .qty-box { display: flex; align-items: center; background: #000; border-radius: 6px; border: 1px solid var(--primary); }
        .q-btn { width: 35px; height: 30px; display: flex; align-items: center; justify-content: center; color: var(--primary); cursor: pointer; }
        .q-num { width: 25px; text-align: center; font-weight: bold; }
        .order-details { background: var(--card); padding: 15px; border-top: 2px solid var(--primary); position: fixed; bottom: 80px; left: 0; right: 0; z-index: 900; display: none; max-width: 600px; margin: 0 auto; max-height: 70vh; overflow-y: auto; }
        .order-details.active { display: block; }
        .close-details { position: absolute; top: 15px; left: 15px; cursor: pointer; }
        .type-selector { display: flex; gap: 10px; margin: 15px 0; }
        .type-btn { flex: 1; padding: 10px; background: #000; border: 1px solid #333; border-radius: 8px; cursor: pointer; text-align: center; }
        .type-btn.selected { background: var(--primary); color: #000; font-weight: bold; }
        .invoice-box { background: #111; padding: 10px; border-radius: 8px; margin-bottom: 15px; }
        .invoice-row { display: flex; justify-content: space-between; font-size: 0.9rem; margin-bottom: 5px; }
        .highlight { color: var(--primary); font-weight: bold; border-top: 1px solid #333; padding-top: 5px; }
        .input-group { margin-bottom: 10px; }
        .input-group input, .input-group textarea { width: 100%; padding: 12px; background: var(--input-bg); border: 1px solid #333; color: #fff; border-radius: 8px; }
        .cart-bar { position: fixed; bottom: 0; left: 0; right: 0; background: #000; padding: 15px; z-index: 1000; display: none; }
        .final-btn { background: var(--green); color: #fff; padding: 12px; border-radius: 12px; font-weight: bold; text-align: center; cursor: pointer; }
        .dev-footer { text-align: center; padding: 30px 20px 80px 20px; background: #0e0e12; }
    </style>
</head>
<body>

    <div class="lang-switch">
        <button class="lang-btn active" id="btn-fa" onclick="setLang('fa')">FA</button>
        <button class="lang-btn" id="btn-en" onclick="setLang('en')">EN</button>
        <button class="lang-btn" id="btn-ar" onclick="setLang('ar')">AR</button>
    </div>

    <header>
        <h1 id="shopName">در حال دریافت...</h1>
        <div id="shopStatus" class="status-badge">...</div>
    </header>

    <div class="cat-scroll" id="cats"></div>
    <div class="menu-list" id="list"></div>

    <div class="dev-footer">
        <p id="devTitle" style="color:#fff; font-weight:bold; margin-bottom:10px;"></p>
        <div style="display:flex; justify-content:center; gap:20px;">
            <a href="tel:09105710039" style="color:var(--primary);">Call</a>
            <a href="#" style="color:var(--primary);">WhatsApp</a>
        </div>
    </div>

    <div class="order-details" id="orderDetails">
        <div class="close-details" onclick="closeOrderWindow()">✕</div>
        <h3 id="revTitle" style="text-align:center; color:var(--primary); margin-bottom:15px;">...</h3>
        <div id="summaryList"></div>
        <div class="type-selector">
            <button class="type-btn selected" id="btn-table" onclick="setMode('table')">...</button>
            <button class="type-btn" id="btn-delivery" onclick="setMode('delivery')">...</button>
        </div>
        <div class="invoice-box">
            <div class="invoice-row"><span id="l-sub">...</span><span id="itemsTotal">0</span></div>
            <div class="invoice-row highlight"><span id="l-total">...</span><span id="finalPayable">0</span></div>
        </div>
        <div class="input-group"><textarea id="userNote"></textarea></div>
        <div id="form-table" class="input-group"><input type="number" id="tableNum"></div>
        <div id="form-delivery" style="display:none">
            <div class="input-group"><input type="tel" id="userPhone"></div>
            <div class="input-group"><textarea id="address"></textarea></div>
        </div>
    </div>

    <div class="cart-bar" id="cartBar"><div class="final-btn" id="actionBtn" onclick="processOrder()">...</div></div>

    <script>
        // ==========================================
        // لینک پرداخت ثابت شده
        const FIXED_PAYMENT_LINK = "https://idpay.ir/"; 
        // ==========================================

        const sheetId = "1XoE-tWd9sor7HgqQe67z3JQCZyvt6G-IcSz9u1miRiw";
        let curLang='fa', products=[], cart={}, dictionary={}, config={ isOpen:true, paymentLink:'' };

        async function startApp() {
            try {
                // استفاده از لینک ثابت
                config.paymentLink = FIXED_PAYMENT_LINK;

                const fetchCsv = async (sheet) => {
                    const r = await fetch(`https://docs.google.com/spreadsheets/d/${sheetId}/gviz/tq?tqx=out:csv&sheet=${sheet}&cb=${Date.now()}`);
                    const text = await r.text();
                    return text.split('\n').map(row => row.split(',').map(c => c.replace(/"/g,'').trim()));
                };
                const [mRows, sRows, tRows] = await Promise.all([fetchCsv('Menu'), fetchCsv('Settings'), fetchCsv('Translations')]);
                
                sRows.forEach(r => {
                    let k = (r[0] || "").toString().toLowerCase().trim();
                    let v = (r[1] || "").toString().trim();
                    if(k.includes('phone')) config.phone = v;
                    if(k.includes('price')) config.deliveryPrice = parseInt(v) || 0;
                    if(k.includes('open')) config.isOpen = v.toUpperCase() !== 'FALSE';
                });

                mRows.slice(1).forEach((r, i) => {
                    if(r.length < 7) return;
                    products.push({ id: i, cat: { fa: r[0], en: r[1], ar: r[2] }, title: { fa: r[3], en: r[4], ar: r[5] }, p: parseInt(r[6].replace(/,/g,'')), img: r[7], active: r[8]?.toUpperCase() !== 'FALSE' });
                });

                tRows.slice(1).forEach(r => { if(r[0]) dictionary[r[0].trim()] = { fa:r[1], en:r[2], ar:r[3] }; });
                setLang('fa');
            } catch (e) { console.error(e); }
        }

        const getT = (k) => (dictionary[k] && dictionary[k][curLang]) ? dictionary[k][curLang] : k;

        function setLang(l) {
            curLang = l;
            document.getElementById('mainHtml').dir = (l === 'en') ? 'ltr' : 'rtl';
            document.querySelectorAll('.lang-btn').forEach(b => b.classList.toggle('active', b.id === 'btn-'+l));
            document.getElementById('shopName').innerText = getT('shopName');
            document.getElementById('revTitle').innerText = getT('review');
            document.getElementById('btn-table').innerText = getT('table');
            document.getElementById('btn-delivery').innerText = getT('delivery');
            document.getElementById('l-sub').innerText = getT('subtotal');
            document.getElementById('l-total').innerText = getT('payable');
            document.getElementById('devTitle').innerText = getT('dev');
            document.getElementById('userNote').placeholder = getT('note');
            document.getElementById('tableNum').placeholder = getT('tNum');
            document.getElementById('userPhone').placeholder = getT('phone');
            document.getElementById('address').placeholder = getT('addr');
            const s = document.getElementById('shopStatus');
            s.innerText = config.isOpen ? getT('open') : getT('closed');
            s.className = "status-badge " + (config.isOpen ? "open" : "closed");
            renderMenu('all');
        }

        function renderMenu(cat) {
            const list = document.getElementById('list'), catsDiv = document.getElementById('cats');
            const catSet = ['all', ...new Set(products.map(p => p.cat[curLang]))];
            catsDiv.innerHTML = catSet.map(c => `<div class="cat-btn ${cat===c?'active':''}" onclick="renderMenu('${c}')">${c==='all'?getT('all'):c}</div>`).join('');
            list.innerHTML = '';
            products.filter(p => cat === 'all' || p.cat[curLang] === cat).forEach(p => {
                const count = cart[p.id] || 0;
                const btn = !p.active ? `<span style="color:#e74c3c;">${getT('out')}</span>` : (count === 0 ? `<div class="add-btn" onclick="upd(${p.id},1)">${getT('add')}</div>` : `<div class="qty-box"><div class="q-btn" onclick="upd(${p.id},-1)">-</div><span class="q-num">${count}</span><div class="q-btn" onclick="upd(${p.id},1)">+</div></div>`);
                list.innerHTML += `<div class="item"><img src="${p.img}"><div style="flex:1"><h3>${p.title[curLang]}</h3><div style="display:flex;justify-content:space-between;margin-top:5px;align-items:center;"><span class="price">${p.p.toLocaleString()}</span>${btn}</div></div></div>`;
            });
            calcTotal();
        }

        window.upd = (id, n) => { if(!config.isOpen) return; cart[id] = (cart[id] || 0) + n; if(cart[id]<=0) delete cart[id]; renderMenu(document.querySelector('.cat-btn.active').innerText === getT('all') ? 'all' : products[id].cat[curLang]); };

        function calcTotal() {
            let total = 0, count = 0, sumHtml = '';
            for(let id in cart) { 
                const p = products[id]; total += p.p * cart[id]; count += cart[id];
                sumHtml += `<div class="summary-item"><span>${p.title[curLang]}</span><div class="qty-box"><div class="q-btn" onclick="upd(${id},-1)">-</div><span class="q-num">${cart[id]}</span><div class="q-btn" onclick="upd(${id},1)">+</div></div><span>${(p.p * cart[id]).toLocaleString()}</span></div>`;
            }
            const isDel = document.getElementById('btn-delivery').classList.contains('selected');
            const final = isDel ? total + config.deliveryPrice : total;
            document.getElementById('itemsTotal').innerText = total.toLocaleString();
            document.getElementById('finalPayable').innerText = final.toLocaleString() + " " + getT('unit');
            document.getElementById('summaryList').innerHTML = sumHtml || "...";
            const bar = document.getElementById('cartBar'), det = document.getElementById('orderDetails');
            bar.style.display = count > 0 ? 'block' : 'none';
            document.getElementById('actionBtn').innerText = det.classList.contains('active') ? (isDel ? getT('payBtn') : getT('submitBtn')) : getT('viewBtn');
        }

        window.setMode = (t) => {
            document.getElementById('btn-table').classList.toggle('selected', t==='table');
            document.getElementById('btn-delivery').classList.toggle('selected', t==='delivery');
            document.getElementById('form-table').style.display = t==='table' ? 'block' : 'none';
            document.getElementById('form-delivery').style.display = t==='delivery' ? 'block' : 'none';
            calcTotal();
        };

        window.processOrder = () => {
            const det = document.getElementById('orderDetails');
            if (!det.classList.contains('active')) { det.classList.add('active'); calcTotal(); return; }
            let finalAmt = 0; for(let id in cart) finalAmt += products[id].p * cart[id];
            const isDel = document.getElementById('btn-delivery').classList.contains('selected');
            if(!isDel) {
                let d = ""; for(let id in cart) d += `${products[id].title[curLang]}(${cart[id]}) - `;
                const n = document.getElementById('tableNum').value || "0";
                window.open(`https://wa.me/${config.phone}?text=${encodeURIComponent(getT('table') + ": " + d)}`);
            } else {
                let msg = getT('confirmMsg').replace('{amount}', document.getElementById('finalPayable').innerText).split('\\n').join('\n');
                if(confirm(msg)) {
                    finalAmt += config.deliveryPrice;
                    let link = config.paymentLink;
                    if(link && link.length > 5) {
                        if(link.includes('idpay.ir')) link += (link.includes('?') ? '&' : '?') + "amount=" + finalAmt + "0";
                        window.location.href = link;
                    } else { alert("لینک پرداخت یافت نشد."); }
                }
            }
        };

        window.closeOrderWindow = () => { document.getElementById('orderDetails').classList.remove('active'); };
        startApp();
    </script>
</body>
</html>
